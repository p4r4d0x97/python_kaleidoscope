<!DOCTYPE html>
<html>
<head>
    <title>Network Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.5.0/dist/socket.io.min.js"></script>
    <style>
        .notification-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 300px;
        }
        .notification {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .online { background-color: #d4edda; }
        .offline { background-color: #f8d7da; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Network Dashboard</h1>
        <form id="filterForm" class="mb-3">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" name="ip" class="form-control" placeholder="IP Filter" value="{{ ip_filter }}">
                </div>
                <div class="col-md-3">
                    <select name="vlan" class="form-control">
                        <option value="">All VLANs</option>
                        {% for vlan in vlans %}
                            <option value="{{ vlan.id }}" {% if vlan_filter == vlan.id|string %}selected{% endif %}>VLAN {{ vlan.id }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" name="refresh" class="form-control" placeholder="Refresh (s)" value="{{ refresh_rate }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </div>
        </form>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>IP Address</th>
                    <th>VLAN</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="deviceTable">
                {% for device in devices %}
                <tr>
                    <td><a href="{{ url_for('history', ip=device.ip) }}" target="_blank">{{ device.ip }}</a></td>
                    <td>{{ device.vlan }}</td>
                    <td>{{ device.status_text }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <nav>
            <ul class="pagination">
                {% for p in range(1, pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=p, ip=ip_filter, vlan=vlan_filter, refresh=refresh_rate) }}">{{ p }}</a>
                    </li>
                {% endfor %}
            </ul>
        </nav>

        <div class="notification-container">
            {% for notification in notifications %}
                <div class="notification {% if notification.status == 'Online' %}online{% else %}offline{% endif %}">
                    {{ notification.ip }} is {{ notification.status }} at {{ notification.time|datetimeformat }}
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        const socket = io();
        socket.on('update', function(data) {
            const tbody = document.getElementById('deviceTable');
            tbody.innerHTML = '';
            Object.keys(data).forEach(ip => {
                const device = data[ip];
                const row = document.createElement('tr');
                const now = Date.now() / 1000;
                let statusText = '';
                if (device.status === 'Online') {
                    const uptime = now - device.first_seen;
                    statusText = `Online for ${Math.floor(uptime / 60)}m ${Math.floor(uptime % 60)}s`;
                } else if (device.status === 'Offline' && device.last_seen) {
                    const downtime = now - device.last_seen;
                    statusText = `Last seen ${Math.floor(downtime / 60)}m ago`;
                } else {
                    statusText = 'No data';
                }
                row.innerHTML = `
                    <td><a href="/history/${ip}" target="_blank">${ip}</a></td>
                    <td>${device.vlan}</td>
                    <td>${statusText}</td>
                `;
                tbody.appendChild(row);
            });
        });

        socket.on('notification', function(data) {
            const container = document.querySelector('.notification-container');
            const div = document.createElement('div');
            div.className = `notification ${data.status.toLowerCase()}`;
            div.textContent = `${data.ip} is ${data.status} at ${data.time}`;
            container.insertBefore(div, container.firstChild);
            if (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        });

        const refreshRate = {{ refresh_rate }} * 1000;
        setTimeout(() => location.reload(), refreshRate);
    </script>
</body>
</html>
