<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Visualization</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    .node-ip:hover { cursor: pointer; }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
    }
    #network {
      width: 100%;
      height: calc(100vh - 160px); /* Adjust for header and controls */
    }
    svg {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
    }
    .controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .legend {
      position: fixed;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 5px;
      border-radius: 50%;
    }
    .highlight {
      stroke: #000;
      stroke-width: 2;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Network Visualization</h1>
    <a href="/" class="mb-4 inline-block text-blue-600 hover:underline">Back to Dashboard</a>
    <div class="controls">
      <div class="flex flex-col mb-2">
        <label for="vlanFilter" class="text-sm font-medium text-gray-700">Filter VLAN</label>
        <select id="vlanFilter" class="mt-1 block w-full rounded-md border-gray-300 px-2 py-1 text-base">
          <option value="all">All VLANs</option>
          {% for vlan in vlans %}
            <option value="{{ vlan.id }}">VLAN {{ vlan.id }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex flex-col">
        <label for="ipSearch" class="text-sm font-medium text-gray-700">Search IP</label>
        <input type="text" id="ipSearch" placeholder="Enter IP or last octet" class="mt-1 block w-full rounded-md border-gray-300 px-2 py-1 text-base">
      </div>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-color" style="background: #FFD700;"></div>VLAN</div>
      <div class="legend-item"><div class="legend-color" style="background: #00FF00;"></div>Online</div>
      <div class="legend-item"><div class="legend-color" style="background: #FF0000;"></div>Offline</div>
      <div class="legend-item"><div class="legend-color" style="background: #808080;"></div>No Data</div>
    </div>
    <div id="network"></div>
  </div>
  <script>
    const socket = io();
    const nodes = JSON.parse('{{ nodes | safe }}');
    const links = JSON.parse('{{ links | safe }}');
    const vlans = JSON.parse('{{ vlans | tojson | safe }}').map(v => v.id);

    let width = window.innerWidth;
    let height = window.innerHeight - 160; // Adjust for header and controls

    // Resize handler
    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight - 160;
      svg.attr('width', width).attr('height', height);
      simulation.force('center', d3.forceCenter(width / 2, height / 2))
             .force('x', d3.forceX().strength(0.1).x(width / 2))
             .force('y', d3.forceY().strength(0.1).y(height / 2));
      simulation.alpha(0.3).restart();
    });

    const svg = d3.select('#network')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .call(d3.zoom().on('zoom', (event) => {
        g.attr('transform', event.transform);
      }));

    const g = svg.append('g');

    let filteredNodes = nodes;
    let filteredLinks = links;

    const simulation = d3.forceSimulation(filteredNodes)
      .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(50))
      .force('charge', d3.forceManyBody().strength(-50)) // Increased for larger nodes
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collide', d3.forceCollide().radius(d => d.type === 'vlan' ? 30 : 15)) // Adjusted for larger nodes
      .force('x', d3.forceX().strength(0.1).x(width / 2))
      .force('y', d3.forceY().strength(0.1).y(height / 2));

    function updateGraph() {
      // Update links
      const link = g.selectAll('line')
        .data(filteredLinks, d => `${d.source.id}-${d.target.id}`);
      link.exit().remove();
      link.enter()
        .append('line')
        .attr('stroke', '#999')
        .attr('stroke-width', 1)
        .merge(link);

      // Update nodes
      const node = g.selectAll('circle')
        .data(filteredNodes, d => d.id);
      node.exit().remove();
      node.enter()
        .append('circle')
        .attr('r', d => d.type === 'vlan' ? 15 : 8) // Increased radius
        .attr('fill', d => {
          if (d.type === 'vlan') return '#FFD700';
          return d.status === 'online' ? '#00FF00' : d.status === 'offline' ? '#FF0000' : '#808080';
        })
        .attr('class', d => d.type === 'ip' ? 'node-ip' : '')
        .call(d3.drag()
          .on('start', dragStarted)
          .on('drag', dragged)
          .on('end', dragEnded))
        .on('click', (event, d) => {
          if (d.type === 'ip') {
            window.open(`/history/${d.id}`, '_blank');
          }
        })
        .merge(node);

      // Update labels
      const label = g.selectAll('text')
        .data(filteredNodes, d => d.id);
      label.exit().remove();
      label.enter()
        .append('text')
        .text(d => d.type === 'vlan' ? `VLAN ${d.vlan}` : d.id.split('.').pop())
        .attr('font-size', 8) // Reduced font size
        .attr('dx', d => d.type === 'vlan' ? 18 : 10) // Adjusted offset
        .attr('dy', 3)
        .attr('fill', '#333')
        .merge(label);

      // Update simulation
      simulation.nodes(filteredNodes);
      simulation.force('link').links(filteredLinks);
      simulation.alpha(0.3).restart();
    }

    const tooltip = d3.select('body')
      .append('div')
      .attr('class', 'tooltip')
      .style('opacity', 0);

    g.selectAll('circle')
      .on('mouseover', (event, d) => {
        tooltip.transition()
          .duration(200)
          .style('opacity', .9);
        tooltip.html(`IP: ${d.id}<br>VLAN: ${d.vlan}<br>Status: ${d.status}`)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 28) + 'px');
      })
      .on('mouseout', () => {
        tooltip.transition()
          .duration(500)
          .style('opacity', 0);
      });

    simulation.on('tick', () => {
      filteredNodes.forEach(d => {
        d.x = Math.max(15, Math.min(width - 15, d.x));
        d.y = Math.max(15, Math.min(height - 15, d.y));
      });

      g.selectAll('line')
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

      g.selectAll('circle')
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);

      g.selectAll('text')
        .attr('x', d => d.x)
        .attr('y', d => d.y);
    });

    function dragStarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragEnded(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    // VLAN filter handler
    d3.select('#vlanFilter').on('change', function() {
      const selectedVlan = this.value;
      if (selectedVlan === 'all') {
        filteredNodes = nodes;
        filteredLinks = links;
      } else {
        const vlanId = parseInt(selectedVlan);
        filteredNodes = nodes.filter(d => d.vlan === vlanId || d.type === 'vlan' && d.vlan === vlanId);
        filteredLinks = links.filter(d => filteredNodes.some(n => n.id === d.source.id) && filteredNodes.some(n => n.id === d.target.id));
      }
      g.selectAll('circle').classed('highlight', false);
      updateGraph();
    });

    // IP search handler
    d3.select('#ipSearch').on('input', function() {
      const searchTerm = this.value.trim().toLowerCase();
      g.selectAll('circle').classed('highlight', false);
      if (searchTerm) {
        const targetNode = filteredNodes.find(d => d.type === 'ip' &&
          (d.id.toLowerCase().includes(searchTerm) || d.id.split('.').pop() === searchTerm));
        if (targetNode) {
          g.selectAll('circle')
            .filter(d => d.id === targetNode.id)
            .classed('highlight', true);
          // Zoom to the node
          const scale = 2;
          const translate = [width / 2 - targetNode.x * scale, height / 2 - targetNode.y * scale];
          svg.transition().duration(750)
            .call(d3.zoom().transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
      }
    });

    socket.on('status_change', data => {
      const nodeToUpdate = nodes.find(n => n.id === data.ip && n.type === 'ip');
      if (nodeToUpdate && filteredNodes.includes(nodeToUpdate)) {
        nodeToUpdate.status = data.status;
        g.selectAll('circle')
          .filter(d => d.id === data.ip && d.type === 'ip')
          .attr('fill', d => d.status === 'online' ? '#00FF00' : d.status === 'offline' ? '#FF0000' : '#808080');
      }
    });

    // Initial graph render
    updateGraph();
  </script>
</body>
</html>
